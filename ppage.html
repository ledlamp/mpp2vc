<script>

    navigator.requestMIDIAccess().then(midi => next(midi)).catch(x=>console.error(x));

        function next(midi) {
            console.log(midi);

            var output = midi.outputs.values().next().value;

            var MIDI_TRANSPOSE = -12;
            var MIDI_KEY_NAMES = ["a-1", "as-1", "b-1"];
            var bare_notes = "c cs d ds e f fs g gs a as b".split(" ");
            for(var oct = 0; oct < 7; oct++) {
                for(var i in bare_notes) {
                    MIDI_KEY_NAMES.push(bare_notes[i] + oct);
                }
            }
            MIDI_KEY_NAMES.push("c7");
            var gMidiOutTest = function(note_name, vel, delay_ms) {
                var note_number = MIDI_KEY_NAMES.indexOf(note_name);
                if(note_number == -1) return;
                note_number = note_number + 9 - MIDI_TRANSPOSE;
        
                output.send([0x90, note_number, vel], window.performance.now() + delay_ms);
            
            }
        
            /*util.js*/function mixin(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])}function EventEmitter(){this._events={}}function hashFnv32a(t,e,n){var i,s,o=void 0===n?2166136261:n;for(i=0,s=t.length;i<s;i++)o^=t.charCodeAt(i),o+=(o<<1)+(o<<4)+(o<<7)+(o<<8)+(o<<24);return e?("0000000"+(o>>>0).toString(16)).substr(-8):o>>>0}function round(t,e,n){return Math.round((t-n)/e)*e+n}EventEmitter.prototype.on=function(t,e){this._events.hasOwnProperty(t)||(this._events[t]=[]),this._events[t].push(e)},EventEmitter.prototype.off=function(t,e){if(this._events.hasOwnProperty(t)){var n=this._events[t].indexOf(e);n<0||this._events[t].splice(n,1)}},EventEmitter.prototype.emit=function(t){if(this._events.hasOwnProperty(t)){var e=this._events[t].slice(0);if(!(e.length<1))for(var n=Array.prototype.slice.call(arguments,1),i=0;i<e.length;i++)e[i].apply(this,n)}};var Knob=function(t,e,n,i,s,o,a){EventEmitter.call(this),this.min=e||0,this.max=n||10,this.step=i||.01,this.value=s||this.min,this.knobValue=(this.value-this.min)/(this.max-this.min),this.name=o||"",this.unit=a||"";var h=i.toString().indexOf(".");-1==h&&(h=i.toString().length-1),this.fixedPoint=i.toString().substr(h).length-1,this.dragY=0,this.mouse_over=!1,this.canvas=t,this.ctx=t.getContext("2d"),this.radius=.3333*this.canvas.width,this.baseImage=document.createElement("canvas"),this.baseImage.width=t.width,this.baseImage.height=t.height;var r=this.baseImage.getContext("2d");r.fillStyle="#444",r.shadowColor="rgba(0, 0, 0, 0.5)",r.shadowBlur=5,r.shadowOffsetX=.02*this.canvas.width,r.shadowOffsetY=.02*this.canvas.width,r.beginPath(),r.arc(this.canvas.width/2,this.canvas.height/2,this.radius,0,2*Math.PI),r.fill();var u=this,c=!1;function v(){var t=document.getElementById("tooltip");if(!t){t=document.createElement("div"),document.body.appendChild(t),t.id="tooltip";var e=u.canvas.getBoundingClientRect();t.style.left=e.left+"px",t.style.top=e.bottom+"px"}t.textContent=u.name,u.name&&(t.textContent+=": "),t.textContent+=u.valueString()+u.unit}function l(){var t=document.getElementById("tooltip");t&&t.parentElement.removeChild(t)}!function(){function n(t){if(t.screenY!==u.dragY){var e=-(t.screenY-u.dragY),n=.0075;t.ctrlKey&&(n*=.05),u.setKnobValue(u.knobValue+e*n),u.dragY=t.screenY,u.redraw()}t.preventDefault(),v()}function i(t){null===t.toElement&&null===t.relatedTarget&&s()}function s(){document.removeEventListener("mousemove",n),document.removeEventListener("mouseout",i),document.removeEventListener("mouseup",s),u.emit("release",u),c=!1,u.mouse_over||l()}t.addEventListener("mousedown",function(t){var e=u.translateMouseEvent(t);u.contains(e.x,e.y)&&(c=!0,u.dragY=t.screenY,v(),document.addEventListener("mousemove",n),document.addEventListener("mouseout",i),document.addEventListener("mouseup",s))}),t.addEventListener("keydown",function(t){38==t.keyCode?(u.setValue(u.value+u.step),v()):40==t.keyCode&&(u.setValue(u.value-u.step),v())})}(),u.canvas.addEventListener("mousemove",function(t){var e=u.translateMouseEvent(t);u.contains(e.x,e.y)?(u.mouse_over=!0,v()):(u.mouse_over=!1,c||l())}),u.canvas.addEventListener("mouseout",function(t){u.mouse_over=!1,c||l()}),this.redraw()};mixin(Knob.prototype,EventEmitter.prototype),Knob.prototype.redraw=function(){var t=.28*this.canvas.width,e=.03*this.canvas.width;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.baseImage,0,0);var n=this.knobValue;n*=2*Math.PI*.8,n+=Math.PI/2,n+=2*Math.PI*.1;var i=this.canvas.width/2,s=Math.cos(n)*t+i,o=Math.sin(n)*t+i;this.ctx.fillStyle="#fff",this.ctx.beginPath(),this.ctx.arc(s,o,e,0,2*Math.PI),this.ctx.fill()},Knob.prototype.setKnobValue=function(t){t<0?t=0:1<t&&(t=1),this.knobValue=t,this.setValue(t*(this.max-this.min)+this.min)},Knob.prototype.setValue=function(t){(t=round(t,this.step,this.min))<this.min?t=this.min:t>this.max&&(t=this.max),this.value!==t&&(this.value=t,this.knobValue=(t-this.min)/(this.max-this.min),this.redraw(),this.emit("change",this))},Knob.prototype.valueString=function(){return this.value.toFixed(this.fixedPoint)},Knob.prototype.contains=function(t,e){return t-=this.canvas.width/2,e-=this.canvas.height/2,Math.sqrt(Math.pow(t,2)+Math.pow(e,2))<this.radius},Knob.prototype.translateMouseEvent=function(t){var e=t.target;return{x:t.clientX-e.getBoundingClientRect().left-e.clientLeft+e.scrollLeft,y:t.clientY-(e.getBoundingClientRect().top-e.clientTop+e.scrollTop)}};
            /*Client.js*/function mixin(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])}function Client(t){EventEmitter.call(this),this.uri=t,this.ws=void 0,this.serverTimeOffset=0,this.user=void 0,this.participantId=void 0,this.channel=void 0,this.ppl={},this.connectionTime=void 0,this.connectionAttempts=0,this.desiredChannelId=void 0,this.desiredChannelSettings=void 0,this.pingInterval=void 0,this.canConnect=!1,this.noteBuffer=[],this.noteBufferTime=0,this.noteFlushInterval=void 0,this.bindEventListeners(),this.emit("status","(Offline mode)")}"undefined"!=typeof module?(module.exports=Client,WebSocket=require("ws"),EventEmitter=require("events").EventEmitter):this.Client=Client,mixin(Client.prototype,EventEmitter.prototype),(Client.prototype.constructor=Client).prototype.isSupported=function(){return"function"==typeof WebSocket},Client.prototype.isConnected=function(){return this.isSupported()&&this.ws&&this.ws.readyState===WebSocket.OPEN},Client.prototype.isConnecting=function(){return this.isSupported()&&this.ws&&this.ws.readyState===WebSocket.CONNECTING},Client.prototype.start=function(){this.canConnect=!0,this.connect()},Client.prototype.stop=function(){this.canConnect=!1,this.ws.close()},Client.prototype.connect=function(){if(this.canConnect&&this.isSupported()&&!this.isConnected()&&!this.isConnecting()){this.emit("status","Connecting..."),"undefined"!=typeof module?this.ws=new WebSocket(this.uri,{origin:"http://www.multiplayerpiano.com"}):this.ws=new WebSocket(this.uri);var o=this;this.ws.addEventListener("close",function(t){o.user=void 0,o.participantId=void 0,o.channel=void 0,o.setParticipants([]),clearInterval(o.pingInterval),clearInterval(o.noteFlushInterval),o.emit("disconnect"),o.emit("status","Offline mode"),o.connectionTime?(o.connectionTime=void 0,o.connectionAttempts=0):++o.connectionAttempts;var e=[50,2950,7e3,1e4],n=o.connectionAttempts;e.length<=n&&(n=e.length-1);var i=e[n];setTimeout(o.connect.bind(o),i)}),this.ws.addEventListener("error",function(){console.trace(arguments),o.ws.close()}),this.ws.addEventListener("open",function(t){o.connectionTime=Date.now(),o.sendArray([{m:"hi"}]),o.pingInterval=setInterval(function(){o.sendArray([{m:"t",e:Date.now()}])},2e4),o.noteBuffer=[],o.noteBufferTime=0,o.noteFlushInterval=setInterval(function(){o.noteBufferTime&&0<o.noteBuffer.length&&(o.sendArray([{m:"n",t:o.noteBufferTime+o.serverTimeOffset,n:o.noteBuffer}]),o.noteBufferTime=0,o.noteBuffer=[])},200),o.emit("connect"),o.emit("status","Joining channel...")}),this.ws.addEventListener("message",function(t){for(var e=JSON.parse(t.data),n=0;n<e.length;n++){var i=e[n];o.emit(i.m,i)}})}},Client.prototype.bindEventListeners=function(){var e=this;this.on("hi",function(t){e.user=t.u,e.receiveServerTime(t.t,t.e||void 0),e.desiredChannelId&&e.setChannel()}),this.on("t",function(t){e.receiveServerTime(t.t,t.e||void 0)}),this.on("ch",function(t){e.desiredChannelId=t.ch._id,e.channel=t.ch,t.p&&(e.participantId=t.p),e.setParticipants(t.ppl)}),this.on("p",function(t){e.participantUpdate(t),e.emit("participant update",e.findParticipantById(t.id))}),this.on("m",function(t){e.ppl.hasOwnProperty(t.id)&&e.participantUpdate(t)}),this.on("bye",function(t){e.removeParticipant(t.p)})},Client.prototype.send=function(t){this.isConnected()&&this.ws.send(t)},Client.prototype.sendArray=function(t){this.send(JSON.stringify(t))},Client.prototype.setChannel=function(t,e){this.desiredChannelId=t||this.desiredChannelId||"lobby",this.desiredChannelSettings=e||this.desiredChannelSettings||void 0,this.sendArray([{m:"ch",_id:this.desiredChannelId,set:this.desiredChannelSettings}])},Client.prototype.offlineChannelSettings={lobby:!0,visible:!1,chat:!1,crownsolo:!1,color:"#ecfaed"},Client.prototype.getChannelSetting=function(t){return this.isConnected()&&this.channel&&this.channel.settings?this.channel.settings[t]:this.offlineChannelSettings[t]},Client.prototype.offlineParticipant={_id:"",name:"",color:"#777"},Client.prototype.getOwnParticipant=function(){return this.findParticipantById(this.participantId)},Client.prototype.setParticipants=function(t){for(var e in this.ppl)if(this.ppl.hasOwnProperty(e)){for(var n=!1,i=0;i<t.length;i++)if(t[i].id===e){n=!0;break}n||this.removeParticipant(e)}for(var o=0;o<t.length;o++)this.participantUpdate(t[o])},Client.prototype.countParticipants=function(){var t=0;for(var e in this.ppl)this.ppl.hasOwnProperty(e)&&++t;return t},Client.prototype.participantUpdate=function(t){var e=this.ppl[t.id]||null;null===e?(e=t,this.ppl[e.id]=e,this.emit("participant added",e),this.emit("count",this.countParticipants())):(t.x&&(e.x=t.x),t.y&&(e.y=t.y),t.color&&(e.color=t.color),t.name&&(e.name=t.name))},Client.prototype.removeParticipant=function(t){if(this.ppl.hasOwnProperty(t)){var e=this.ppl[t];delete this.ppl[t],this.emit("participant removed",e),this.emit("count",this.countParticipants())}},Client.prototype.findParticipantById=function(t){return this.ppl[t]||this.offlineParticipant},Client.prototype.isOwner=function(){return this.channel&&this.channel.crown&&this.channel.crown.participantId===this.participantId},Client.prototype.preventsPlaying=function(){return this.isConnected()&&!this.isOwner()&&!0===this.getChannelSetting("crownsolo")},Client.prototype.receiveServerTime=function(t,e){var n,i=this,o=t-Date.now(),s=0,r=(o-this.serverTimeOffset)/50;n=setInterval(function(){i.serverTimeOffset+=r,50<=++s&&(clearInterval(n),i.serverTimeOffset=o)},20)},Client.prototype.startNote=function(t,e){if(this.isConnected()){e=void 0===e?void 0:+e.toFixed(3);this.noteBufferTime?this.noteBuffer.push({d:Date.now()-this.noteBufferTime,n:t,v:e}):(this.noteBufferTime=Date.now(),this.noteBuffer.push({n:t,v:e}))}},Client.prototype.stopNote=function(t){this.isConnected()&&(this.noteBufferTime?this.noteBuffer.push({d:Date.now()-this.noteBufferTime,n:t,s:1}):(this.noteBufferTime=Date.now(),this.noteBuffer.push({n:t,s:1})))};
            var gClient = new Client("ws://www.multiplayerpiano.com:443");
            gClient.setChannel("lobby");
            gClient.start();
        
            gClient.on("n", function(msg) {
                var t = msg.t - gClient.serverTimeOffset + 1000 - Date.now();
        
                for(var i = 0; i < msg.n.length; i++) {
                    var note = msg.n[i];
                    var ms = t + (note.d || 0);
                    if(ms < 0) {
                        ms = 0;
                    }
                    else if(ms > 10000) continue;
                    if(note.s) {
                        gMidiOutTest(note.n, 0, ms);
                    } else {
                        var vel = (typeof note.v !== "undefined")? parseFloat(note.v) : DEFAULT_VELOCITY;
                        if(vel < 0) vel = 0; else if (vel > 1) vel = 1;
                        gMidiOutTest(note.n, vel * 127, ms);
                    }
                }
            });
        }


    </script>